<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e1e1e1;
      min-height: 100vh;
    }

    .container {
      max-width: 680px;
      margin: 0 auto;
      padding: 16px;
    }

    /* ── 헤더 ── */
    .header {
      text-align: center;
      padding: 32px 0 24px;
    }
    .header h1 {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      letter-spacing: -0.5px;
    }
    .header h1 span { color: #ff4444; }
    .header p {
      color: #555;
      font-size: 13px;
      margin-top: 4px;
    }

    /* ── 입력 ── */
    .input-group {
      background: #141414;
      border: 1px solid #222;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .input-row {
      display: flex;
      gap: 8px;
    }
    .input-row input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #2a2a2a;
      background: #0a0a0a;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-row input:focus { border-color: #ff4444; }
    .input-row input::placeholder { color: #444; }
    .options-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .options-row select {
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid #2a2a2a;
      background: #0a0a0a;
      color: #999;
      font-size: 13px;
      outline: none;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23555'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }
    .options-row .email-input {
      flex: 1;
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid #2a2a2a;
      background: #0a0a0a;
      color: #fff;
      font-size: 13px;
      outline: none;
    }
    .options-row .email-input::placeholder { color: #383838; }
    .btn {
      padding: 12px 22px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .btn-start { background: #ff4444; color: #fff; }
    .btn-start:hover { background: #e83333; transform: scale(1.02); }
    .btn-start:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; }
    .btn-stop { background: #222; color: #999; font-size: 13px; padding: 8px 16px; }
    .btn-stop:hover { background: #2a2a2a; color: #fff; }

    /* ── 트래커 ── */
    .tracker { display: none; }
    .tracker.active { display: block; }

    /* ── 비디오 정보 ── */
    .video-info {
      display: flex;
      gap: 12px;
      background: #141414;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      align-items: center;
    }
    .video-info img {
      width: 120px;
      height: 68px;
      border-radius: 8px;
      object-fit: cover;
      background: #222;
      flex-shrink: 0;
    }
    .video-meta { min-width: 0; }
    .video-meta h3 {
      font-size: 14px;
      color: #fff;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .video-meta .channel-name {
      color: #666;
      font-size: 12px;
      margin-top: 2px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      margin-top: 4px;
      letter-spacing: 0.5px;
    }
    .badge-waiting { background: #2a2200; color: #ffa500; }
    .badge-live { background: #ff0000; color: #fff; animation: livePulse 1.5s ease-in-out infinite; }
    .badge-ended { background: #1a1a1a; color: #666; }
    .badge-error { background: #2a1111; color: #ff6666; }
    @keyframes livePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* ── 통계 ── */
    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    .stat {
      background: #141414;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .stat .val {
      font-size: 36px;
      font-weight: 800;
      color: #fff;
      line-height: 1;
      letter-spacing: -1px;
    }
    .stat .lbl {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .stat.peak .val { color: #ff4444; }
    .stat .time-sub {
      font-size: 11px;
      color: #333;
      margin-top: 2px;
    }

    /* ── 차트 ── */
    .chart-wrap {
      background: #141414;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 130px;
    }

    /* ── 로그 (접이식) ── */
    .log-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #141414;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 12px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }
    .log-toggle:hover { background: #1a1a1a; }
    .log-toggle span { font-size: 13px; color: #555; }
    .log-toggle .arrow { color: #444; font-size: 12px; transition: transform 0.2s; }
    .log-toggle.open .arrow { transform: rotate(180deg); }
    .log-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .log-body.open {
      max-height: 300px;
    }
    .log-list {
      background: #111;
      border-radius: 0 0 12px 12px;
      padding: 12px 16px;
      margin-top: -12px;
      margin-bottom: 12px;
      max-height: 180px;
      overflow-y: auto;
      font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
      font-size: 12px;
      line-height: 2;
      color: #555;
    }
    .log-list::-webkit-scrollbar { width: 4px; }
    .log-list::-webkit-scrollbar-thumb { background: #222; border-radius: 2px; }
    .log-entry.peak { color: #ff4444; }

    /* ── 이메일 배지 ── */
    .email-badge {
      text-align: center;
      padding: 10px;
      background: #0d1f0d;
      border: 1px solid #1a3a1a;
      border-radius: 10px;
      color: #4caf50;
      font-size: 13px;
      margin-bottom: 12px;
    }

    /* ── 메시지 ── */
    .message {
      text-align: center;
      padding: 30px 20px;
      color: #444;
      font-size: 14px;
    }
    .message .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #333;
      border-top-color: #ff4444;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── 액션 바 ── */
    .action-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    /* ── 히스토리 ── */
    .history-section { margin-top: 24px; }
    .history-section h3 {
      font-size: 13px;
      color: #444;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .hi {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #141414;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .hi:hover { background: #1a1a1a; }
    .hi-left { min-width: 0; flex: 1; }
    .hi-title {
      font-size: 13px;
      color: #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hi-sub { font-size: 11px; color: #444; margin-top: 2px; }
    .hi-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .hi-num { font-size: 14px; font-weight: 700; color: #ff4444; }
    .hi-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    .hi-badge-live { background: #ff0000; color: #fff; }
    .hi-badge-ended { background: #1a1a1a; color: #555; }
    .hi-badge-waiting { background: #2a2200; color: #ffa500; }

    /* ── 모바일 ── */
    @media (max-width: 500px) {
      .container { padding: 12px; }
      .input-row { flex-direction: column; }
      .stat .val { font-size: 28px; }
      .video-info img { width: 80px; height: 45px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><span>Live</span> Tracker</h1>
      <p>YouTube 라이브 동접자 추적</p>
    </div>

    <div class="input-group">
      <div class="input-row">
        <input type="text" id="urlInput" placeholder="YouTube 라이브 URL" />
        <button class="btn btn-start" id="startBtn" onclick="startTracking()">추적</button>
      </div>
      <div class="options-row">
        <select id="intervalSelect">
          <option value="10">10초</option>
          <option value="30" selected>30초</option>
          <option value="60">1분</option>
          <option value="180">3분</option>
          <option value="300">5분</option>
        </select>
        <input type="email" id="emailInput" class="email-input" placeholder="결과 받을 이메일 (선택)" style="display:none" />
      </div>
    </div>

    <div class="tracker" id="tracker">
      <div class="video-info" id="videoInfo" style="display:none">
        <img id="thumbnail" src="" alt="" />
        <div class="video-meta">
          <h3 id="videoTitle">-</h3>
          <div class="channel-name" id="channelName">-</div>
          <span class="badge badge-waiting" id="statusBadge">WAITING</span>
        </div>
      </div>

      <div class="message" id="statusMessage"><span class="spinner"></span>연결 중...</div>

      <div class="stats-row" id="statsArea" style="display:none">
        <div class="stat">
          <div class="val" id="currentViewers">0</div>
          <div class="lbl">현재</div>
        </div>
        <div class="stat peak">
          <div class="val" id="maxViewers">0</div>
          <div class="lbl">최대 동접</div>
          <div class="time-sub" id="maxTime"></div>
        </div>
      </div>

      <div class="chart-wrap" id="chartArea" style="display:none">
        <div class="chart-container">
          <canvas id="viewerChart"></canvas>
        </div>
      </div>

      <div id="logWrap" style="display:none">
        <div class="log-toggle" id="logToggle" onclick="toggleLog()">
          <span>추적 로그</span>
          <span class="arrow">&#9660;</span>
        </div>
        <div class="log-body" id="logBody">
          <div class="log-list" id="logList"></div>
        </div>
      </div>

      <div id="emailSentBadge" class="email-badge" style="display:none">
        &#10003; 결과가 이메일로 발송되었습니다
      </div>

      <div class="action-bar" id="actionBar" style="display:none">
        <button class="btn btn-stop" id="stopBtn" onclick="stopTracking()">추적 중단</button>
      </div>
    </div>

    <div class="history-section" id="historySection" style="display:none">
      <h3>최근 기록</h3>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    let sessionId = null;
    let eventSource = null;
    let chart = null;
    let prevHistoryLen = 0;

    fetch('/api/email-available').then(r => r.json()).then(d => {
      if (d.available) document.getElementById('emailInput').style.display = 'block';
    });

    function startTracking() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) return;
      const email = document.getElementById('emailInput')?.value.trim() || '';
      const interval = parseInt(document.getElementById('intervalSelect').value);

      document.getElementById('startBtn').disabled = true;
      document.getElementById('startBtn').textContent = '...';
      document.getElementById('tracker').classList.add('active');
      document.getElementById('statusMessage').innerHTML = '<span class="spinner"></span>영상 확인 중...';
      document.getElementById('statusMessage').style.display = 'block';
      document.getElementById('historySection').style.display = 'none';

      // reset
      if (chart) { chart.destroy(); chart = null; }
      prevHistoryLen = 0;
      document.getElementById('videoInfo').style.display = 'none';
      document.getElementById('statsArea').style.display = 'none';
      document.getElementById('chartArea').style.display = 'none';
      document.getElementById('logWrap').style.display = 'none';
      document.getElementById('emailSentBadge').style.display = 'none';

      fetch('/api/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, email, interval })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) { alert(data.error); resetUI(); return; }
        sessionId = data.session_id;
        document.getElementById('actionBar').style.display = 'flex';
        connectSSE();
      })
      .catch(() => { alert('서버 연결 실패'); resetUI(); });
    }

    function connectSSE() {
      if (eventSource) eventSource.close();
      eventSource = new EventSource(`/api/stream/${sessionId}`);
      eventSource.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.error) { resetUI(); return; }
        updateUI(d);
      };
      eventSource.onerror = () => {
        eventSource.close();
        if (sessionId) fetch(`/api/status/${sessionId}`).then(r => r.json()).then(updateUI);
      };
    }

    function updateUI(d) {
      if (d.title) {
        document.getElementById('videoInfo').style.display = 'flex';
        document.getElementById('videoTitle').textContent = d.title;
        document.getElementById('channelName').textContent = d.channel;
        if (d.thumbnail) document.getElementById('thumbnail').src = d.thumbnail;
      }

      const b = document.getElementById('statusBadge');
      b.className = 'badge';
      if (d.status === 'waiting') {
        b.classList.add('badge-waiting'); b.textContent = 'WAITING';
        document.getElementById('statusMessage').innerHTML = '<span class="spinner"></span>' + d.message;
      } else if (d.status === 'live') {
        b.classList.add('badge-live'); b.textContent = 'LIVE';
        document.getElementById('statusMessage').style.display = 'none';
        document.getElementById('statsArea').style.display = 'grid';
        document.getElementById('chartArea').style.display = 'block';
        document.getElementById('logWrap').style.display = 'block';
      } else if (d.status === 'ended') {
        b.classList.add('badge-ended'); b.textContent = 'ENDED';
        document.getElementById('actionBar').style.display = 'none';
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = '추적';
        document.getElementById('statsArea').style.display = 'grid';
        document.getElementById('chartArea').style.display = 'block';
        document.getElementById('logWrap').style.display = 'block';
        if (d.email_sent) document.getElementById('emailSentBadge').style.display = 'block';
        if (d.message) {
          document.getElementById('statusMessage').innerHTML = d.message;
          document.getElementById('statusMessage').style.display = 'block';
        }
        loadHistory();
      } else if (d.status === 'error') {
        b.classList.add('badge-error'); b.textContent = 'ERROR';
        document.getElementById('statusMessage').innerHTML = d.message;
        document.getElementById('statusMessage').style.display = 'block';
        document.getElementById('actionBar').style.display = 'none';
        resetUI();
      }

      // 숫자
      animateNumber('currentViewers', d.current_viewers);
      animateNumber('maxViewers', d.max_viewers);
      if (d.max_viewers_time) document.getElementById('maxTime').textContent = d.max_viewers_time;

      // 차트
      if (d.history && d.history.length > prevHistoryLen) {
        updateChart(d.history);
        prevHistoryLen = d.history.length;
      }

      // 로그
      if (d.history && d.history.length > 0) {
        const el = document.getElementById('logList');
        el.innerHTML = d.history.slice(-40).reverse().map(h => {
          const cls = (h.viewers === d.max_viewers && h.time === d.max_viewers_time) ? ' peak' : '';
          return `<div class="log-entry${cls}">${h.time}  ${h.viewers.toLocaleString()}명</div>`;
        }).join('');
      }
    }

    function animateNumber(id, target) {
      const el = document.getElementById(id);
      const current = parseInt(el.textContent.replace(/,/g, '')) || 0;
      if (current === target) return;
      el.textContent = target.toLocaleString();
      el.style.transform = 'scale(1.08)';
      setTimeout(() => { el.style.transform = 'scale(1)'; }, 200);
    }

    function updateChart(history) {
      const labels = history.map(h => h.time);
      const values = history.map(h => h.viewers);

      // 차트가 커지는 버그 방지: 매번 destroy 후 재생성
      if (chart) {
        chart.destroy();
        chart = null;
      }

      const canvas = document.getElementById('viewerChart');
      const ctx = canvas.getContext('2d');
      const grad = ctx.createLinearGradient(0, 0, 0, 130);
      grad.addColorStop(0, 'rgba(255,68,68,0.12)');
      grad.addColorStop(1, 'rgba(255,68,68,0)');

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: values,
            borderColor: '#ff4444',
            backgroundColor: grad,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHitRadius: 10,
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          layout: { padding: { top: 4, bottom: 0 } },
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#222',
              titleColor: '#888',
              bodyColor: '#fff',
              cornerRadius: 8,
              padding: 10,
              displayColors: false,
              callbacks: {
                label: (c) => `${c.parsed.y.toLocaleString()}명`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#333', font: { size: 10 }, maxTicksLimit: 6, maxRotation: 0 },
              grid: { display: false },
              border: { display: false }
            },
            y: {
              beginAtZero: false,
              ticks: {
                color: '#333',
                font: { size: 10 },
                maxTicksLimit: 3,
                callback: (v) => v >= 1000 ? (v/1000).toFixed(1) + 'k' : v
              },
              grid: { color: '#1a1a1a' },
              border: { display: false }
            }
          }
        }
      });
    }

    function toggleLog() {
      document.getElementById('logToggle').classList.toggle('open');
      document.getElementById('logBody').classList.toggle('open');
    }

    function stopTracking() {
      if (!sessionId) return;
      fetch(`/api/stop/${sessionId}`, { method: 'POST' });
      if (eventSource) eventSource.close();
      document.getElementById('actionBar').style.display = 'none';
      resetUI();
    }

    function resetUI() {
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = '추적';
    }

    document.getElementById('urlInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') startTracking();
    });

    function loadHistory() {
      fetch('/api/history').then(r => r.json()).then(data => {
        if (!data || data.length === 0) return;
        document.getElementById('historySection').style.display = 'block';
        document.getElementById('historyList').innerHTML = data.map(s => {
          const bc = s.status === 'live' ? 'hi-badge-live' : s.status === 'waiting' ? 'hi-badge-waiting' : 'hi-badge-ended';
          const bt = s.status === 'live' ? 'LIVE' : s.status === 'waiting' ? 'WAIT' : 'END';
          return `<div class="hi" onclick="viewSession('${s.id}')">
            <div class="hi-left">
              <div class="hi-title">${s.title || s.url}</div>
              <div class="hi-sub">${s.channel || ''} &middot; ${s.created_at || ''}</div>
            </div>
            <div class="hi-right">
              <span class="hi-num">${(s.max_viewers||0).toLocaleString()}</span>
              <span class="hi-badge ${bc}">${bt}</span>
            </div>
          </div>`;
        }).join('');
      });
    }
    loadHistory();

    function viewSession(sid) {
      sessionId = sid;
      document.getElementById('tracker').classList.add('active');
      fetch(`/api/status/${sid}`).then(r => r.json()).then(d => {
        updateUI(d);
        if (d.status === 'live' || d.status === 'waiting') {
          document.getElementById('actionBar').style.display = 'flex';
          connectSSE();
        }
      });
    }
  </script>
</body>
</html>
