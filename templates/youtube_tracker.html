<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube ë¼ì´ë¸Œ ë™ì ‘ ì¶”ì ê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #e1e1e1;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    /* í—¤ë” */
    .header {
      text-align: center;
      padding: 40px 0 30px;
    }
    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }
    .header p {
      color: #aaa;
      font-size: 14px;
    }

    /* ì…ë ¥ í¼ */
    .input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    .input-area input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-area input:focus {
      border-color: #ff4444;
    }
    .input-area input::placeholder {
      color: #666;
    }
    .btn {
      padding: 14px 28px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-start {
      background: #ff4444;
      color: #fff;
    }
    .btn-start:hover { background: #ff2222; }
    .btn-start:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .btn-stop {
      background: #333;
      color: #fff;
    }
    .btn-stop:hover { background: #444; }

    /* ìƒíƒœ ì˜ì—­ */
    .tracker { display: none; }
    .tracker.active { display: block; }

    /* ë¹„ë””ì˜¤ ì •ë³´ */
    .video-info {
      display: flex;
      gap: 16px;
      background: #1a1a1a;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      align-items: center;
    }
    .video-info img {
      width: 160px;
      height: 90px;
      border-radius: 8px;
      object-fit: cover;
      background: #333;
    }
    .video-meta h3 {
      font-size: 16px;
      color: #fff;
      margin-bottom: 4px;
      line-height: 1.3;
    }
    .video-meta .channel-name {
      color: #aaa;
      font-size: 13px;
    }

    /* ìƒíƒœ ë°°ì§€ */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }
    .status-waiting { background: #333; color: #ffa500; }
    .status-live { background: #ff0000; color: #fff; animation: pulse 2s infinite; }
    .status-ended { background: #333; color: #888; }
    .status-error { background: #442222; color: #ff6666; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* í° ìˆ«ì ì¹´ë“œ */
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }
    .stat-card .label {
      font-size: 13px;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .stat-card .number {
      font-size: 42px;
      font-weight: 800;
      color: #fff;
    }
    .stat-card .sub {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .stat-card.highlight .number {
      color: #ff4444;
    }

    /* ì°¨íŠ¸ */
    .chart-area {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .chart-area h4 {
      font-size: 14px;
      color: #888;
      margin-bottom: 12px;
    }

    /* ë¡œê·¸ */
    .log-area {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 16px;
    }
    .log-area h4 {
      font-size: 14px;
      color: #888;
      margin-bottom: 10px;
    }
    .log-list {
      max-height: 200px;
      overflow-y: auto;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 13px;
      line-height: 1.8;
      color: #aaa;
    }
    .log-list::-webkit-scrollbar { width: 6px; }
    .log-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* ì´ë©”ì¼ */
    .email-area {
      margin: -20px 0 24px;
    }
    .email-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 4px 4px 4px 14px;
    }
    .email-icon { font-size: 18px; color: #666; }
    .email-row input {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 15px;
      outline: none;
    }
    .email-row input::placeholder { color: #555; }
    .email-hint {
      font-size: 12px;
      color: #555;
      margin-top: 6px;
      padding-left: 4px;
    }
    .email-sent-badge {
      display: inline-block;
      background: #1a3a1a;
      color: #4caf50;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 12px;
    }

    /* ìµœê·¼ ê¸°ë¡ */
    .history-section {
      margin-top: 40px;
    }
    .history-section h3 {
      font-size: 16px;
      color: #888;
      margin-bottom: 12px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .history-item:hover { background: #222; }
    .history-item .hi-title {
      color: #ddd;
      font-size: 14px;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 12px;
    }
    .history-item .hi-channel {
      color: #666;
      font-size: 12px;
    }
    .history-item .hi-viewers {
      color: #ff4444;
      font-weight: 700;
      font-size: 15px;
      white-space: nowrap;
    }
    .history-item .hi-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 10px;
    }
    .hi-status-ended { background: #333; color: #888; }
    .hi-status-live { background: #ff0000; color: #fff; }
    .hi-status-waiting { background: #333; color: #ffa500; }

    .message {
      text-align: center;
      padding: 40px;
      color: #888;
      font-size: 15px;
    }

    /* ëª¨ë°”ì¼ */
    @media (max-width: 600px) {
      .input-area { flex-direction: column; }
      .video-info { flex-direction: column; align-items: flex-start; }
      .video-info img { width: 100%; height: auto; }
      .stat-card .number { font-size: 32px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>YouTube Live Tracker</h1>
      <p>ë¼ì´ë¸Œ ë§í¬ë¥¼ ë„£ìœ¼ë©´ ìµœëŒ€ ë™ì ‘ìë¥¼ ì¶”ì í•©ë‹ˆë‹¤</p>
    </div>

    <div class="input-area">
      <input type="text" id="urlInput" placeholder="YouTube ë¼ì´ë¸Œ URL ë¶™ì—¬ë„£ê¸°..." />
      <button class="btn btn-start" id="startBtn" onclick="startTracking()">ì¶”ì  ì‹œì‘</button>
    </div>

    <div class="email-area" id="emailArea" style="display:none">
      <div class="email-row">
        <span class="email-icon">&#9993;</span>
        <input type="email" id="emailInput" placeholder="ê²°ê³¼ ë°›ì„ ì´ë©”ì¼ (ì„ íƒì‚¬í•­)" />
      </div>
      <div class="email-hint">ë¼ì´ë¸Œ ì¢…ë£Œ ì‹œ ê²°ê³¼ë¥¼ ì´ë©”ì¼ë¡œ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤</div>
    </div>

    <div class="tracker" id="tracker">
      <!-- ë¹„ë””ì˜¤ ì •ë³´ -->
      <div class="video-info" id="videoInfo" style="display:none">
        <img id="thumbnail" src="" alt="" />
        <div class="video-meta">
          <h3 id="videoTitle">-</h3>
          <div class="channel-name" id="channelName">-</div>
          <span class="status-badge status-waiting" id="statusBadge">ëŒ€ê¸° ì¤‘</span>
        </div>
      </div>

      <!-- ë©”ì‹œì§€ -->
      <div class="message" id="statusMessage">ì—°ê²° ì¤‘...</div>

      <!-- í†µê³„ ì¹´ë“œ -->
      <div class="stats" id="statsArea" style="display:none">
        <div class="stat-card">
          <div class="label">í˜„ì¬ ì‹œì²­ì</div>
          <div class="number" id="currentViewers">0</div>
          <div class="sub">ëª…</div>
        </div>
        <div class="stat-card highlight">
          <div class="label">ìµœëŒ€ ë™ì ‘</div>
          <div class="number" id="maxViewers">0</div>
          <div class="sub" id="maxTime">-</div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ -->
      <div class="chart-area" id="chartArea" style="display:none">
        <h4>ë™ì ‘ì ì¶”ì´</h4>
        <canvas id="viewerChart" height="200"></canvas>
      </div>

      <!-- ë¡œê·¸ -->
      <div class="log-area" id="logArea" style="display:none">
        <h4>ì¶”ì  ë¡œê·¸</h4>
        <div class="log-list" id="logList"></div>
      </div>

      <!-- ì´ë©”ì¼ ë°œì†¡ ê²°ê³¼ -->
      <div id="emailSentBadge" class="email-sent-badge" style="display:none; text-align:center">
        &#10003; ê²°ê³¼ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤
      </div>

      <!-- ì¤‘ë‹¨ ë²„íŠ¼ -->
      <div style="text-align:center; margin-top:20px">
        <button class="btn btn-stop" id="stopBtn" onclick="stopTracking()" style="display:none">ì¶”ì  ì¤‘ë‹¨</button>
      </div>
    </div>
    <!-- ìµœê·¼ ê¸°ë¡ -->
    <div class="history-section" id="historySection" style="display:none">
      <h3>ìµœê·¼ ì¶”ì  ê¸°ë¡</h3>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    let sessionId = null;
    let eventSource = null;
    let chart = null;
    let prevHistoryLen = 0;

    // ì´ë©”ì¼ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    fetch('/api/email-available').then(r => r.json()).then(data => {
      if (data.available) {
        document.getElementById('emailArea').style.display = 'block';
      }
    });

    function startTracking() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) { alert('YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      const email = document.getElementById('emailInput')?.value.trim() || '';

      document.getElementById('startBtn').disabled = true;
      document.getElementById('startBtn').textContent = 'ì—°ê²° ì¤‘...';
      document.getElementById('tracker').classList.add('active');
      document.getElementById('statusMessage').textContent = 'ì˜ìƒ ì •ë³´ í™•ì¸ ì¤‘...';
      document.getElementById('statusMessage').style.display = 'block';

      fetch('/api/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, email })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          resetUI();
          return;
        }
        sessionId = data.session_id;
        document.getElementById('stopBtn').style.display = 'inline-block';
        connectSSE();
      })
      .catch(() => {
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        resetUI();
      });
    }

    function connectSSE() {
      eventSource = new EventSource(`/api/stream/${sessionId}`);

      eventSource.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.error) { resetUI(); return; }
        updateUI(data);
      };

      eventSource.onerror = () => {
        // SSE ì—°ê²° ëŠê¸°ë©´ ë§ˆì§€ë§‰ ìƒíƒœ fetch
        eventSource.close();
        if (sessionId) {
          fetch(`/api/status/${sessionId}`).then(r => r.json()).then(updateUI);
        }
      };
    }

    function updateUI(data) {
      // ë¹„ë””ì˜¤ ì •ë³´
      if (data.title) {
        document.getElementById('videoInfo').style.display = 'flex';
        document.getElementById('videoTitle').textContent = data.title;
        document.getElementById('channelName').textContent = data.channel;
        if (data.thumbnail) {
          document.getElementById('thumbnail').src = data.thumbnail;
        }
      }

      // ìƒíƒœ ë°°ì§€
      const badge = document.getElementById('statusBadge');
      badge.className = 'status-badge';
      if (data.status === 'waiting') {
        badge.classList.add('status-waiting');
        badge.textContent = 'ëŒ€ê¸° ì¤‘';
        document.getElementById('statusMessage').textContent = data.message;
      } else if (data.status === 'live') {
        badge.classList.add('status-live');
        badge.textContent = 'LIVE';
        document.getElementById('statusMessage').style.display = 'none';
        document.getElementById('statsArea').style.display = 'grid';
        document.getElementById('chartArea').style.display = 'block';
        document.getElementById('logArea').style.display = 'block';
      } else if (data.status === 'ended') {
        badge.classList.add('status-ended');
        badge.textContent = 'ì¢…ë£Œ';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'ì¶”ì  ì‹œì‘';
        document.getElementById('statsArea').style.display = 'grid';
        document.getElementById('chartArea').style.display = 'block';
        document.getElementById('logArea').style.display = 'block';
        if (data.email_sent) {
          document.getElementById('emailSentBadge').style.display = 'block';
        }
        if (data.message) {
          document.getElementById('statusMessage').textContent = data.message;
          document.getElementById('statusMessage').style.display = 'block';
        }
      } else if (data.status === 'error') {
        badge.classList.add('status-error');
        badge.textContent = 'ì˜¤ë¥˜';
        document.getElementById('statusMessage').textContent = data.message;
        document.getElementById('statusMessage').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'ì¶”ì  ì‹œì‘';
      }

      // ìˆ«ì ì—…ë°ì´íŠ¸
      document.getElementById('currentViewers').textContent = data.current_viewers.toLocaleString();
      document.getElementById('maxViewers').textContent = data.max_viewers.toLocaleString();
      if (data.max_viewers_time) {
        document.getElementById('maxTime').textContent = data.max_viewers_time;
      }

      // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      if (data.history && data.history.length > prevHistoryLen) {
        updateChart(data.history);
        prevHistoryLen = data.history.length;
      }

      // ë¡œê·¸ ì—…ë°ì´íŠ¸
      if (data.history && data.history.length > 0) {
        const logList = document.getElementById('logList');
        logList.innerHTML = data.history.slice(-30).reverse().map(h => {
          const isMax = h.viewers === data.max_viewers && h.time === data.max_viewers_time;
          return `<div>${h.time} - ${h.viewers.toLocaleString()}ëª…${isMax ? ' ğŸ†' : ''}</div>`;
        }).join('');
      }
    }

    function updateChart(history) {
      const labels = history.map(h => h.time);
      const values = history.map(h => h.viewers);

      if (!chart) {
        const ctx = document.getElementById('viewerChart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'ë™ì ‘ì',
              data: values,
              borderColor: '#ff4444',
              backgroundColor: 'rgba(255, 68, 68, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 3,
              pointBackgroundColor: '#ff4444',
              borderWidth: 2,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.parsed.y.toLocaleString()}ëª…`
                }
              }
            },
            scales: {
              x: {
                ticks: { color: '#666', maxTicksLimit: 10 },
                grid: { color: '#222' }
              },
              y: {
                ticks: {
                  color: '#666',
                  callback: (v) => v.toLocaleString()
                },
                grid: { color: '#222' }
              }
            }
          }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.update('none');
      }
    }

    function stopTracking() {
      if (!sessionId) return;
      fetch(`/api/stop/${sessionId}`, { method: 'POST' });
      if (eventSource) eventSource.close();
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'ì¶”ì  ì‹œì‘';
    }

    function resetUI() {
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'ì¶”ì  ì‹œì‘';
    }

    // ì—”í„°í‚¤ë¡œ ì‹œì‘
    document.getElementById('urlInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') startTracking();
    });

    // ìµœê·¼ ê¸°ë¡ ë¡œë“œ
    function loadHistory() {
      fetch('/api/history').then(r => r.json()).then(data => {
        if (!data || data.length === 0) return;
        document.getElementById('historySection').style.display = 'block';
        const list = document.getElementById('historyList');
        list.innerHTML = data.map(s => {
          const statusClass = s.status === 'live' ? 'hi-status-live' :
                              s.status === 'waiting' ? 'hi-status-waiting' : 'hi-status-ended';
          const statusText = s.status === 'live' ? 'LIVE' :
                             s.status === 'waiting' ? 'ëŒ€ê¸°' : 'ì¢…ë£Œ';
          return `
            <div class="history-item" onclick="viewSession('${s.id}')">
              <div>
                <div class="hi-title">${s.title || s.url}</div>
                <div class="hi-channel">${s.channel || ''} &middot; ${s.created_at || ''}</div>
              </div>
              <div style="display:flex;align-items:center">
                <span class="hi-viewers">${(s.max_viewers||0).toLocaleString()}ëª…</span>
                <span class="hi-status ${statusClass}">${statusText}</span>
              </div>
            </div>`;
        }).join('');
      });
    }
    loadHistory();

    function viewSession(sid) {
      sessionId = sid;
      document.getElementById('tracker').classList.add('active');
      // ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ì´ë©´ SSE, ì•„ë‹ˆë©´ í•œ ë²ˆë§Œ fetch
      fetch(`/api/status/${sid}`).then(r => r.json()).then(data => {
        updateUI(data);
        if (data.status === 'live' || data.status === 'waiting') {
          document.getElementById('stopBtn').style.display = 'inline-block';
          connectSSE();
        }
      });
    }
  </script>
</body>
</html>
